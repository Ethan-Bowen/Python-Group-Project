{% extends "core/base.html" %}
{% load static %}

{% block content %}
<h2>Shift Calendar</h2>

<button id="createShiftBtn" class="btn btn-primary mb-3">
    Create Shift
</button>

<div id="calendar"></div>

<!-- Create Shift Modal -->
<div class="modal fade" id="createShiftModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Create Shift</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="createShiftForm">

          <div class="mb-3">
            <label class="form-label">Date</label>
            <input type="date" id="shiftDate" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Start Time</label>
            <input type="time" id="shiftStart" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">End Time</label>
            <input type="time" id="shiftEnd" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Role Needed</label>
            <select id="shiftRole" class="form-select" required>
              <option value="">Select a role</option>
              {% for role in roles %}
                <option value="{{ role.id }}">{{ role.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Assign Employee (optional)</label>
            <select id="shiftEmployee" class="form-select">
              <option value="">Unassigned</option>
              {% for emp in employees %}
                <option value="{{ emp.user.id }}">
                  <a href="{% url 'profile_detail' emp.user.id %}">
                     {{ emp.user.first_name }} {{ emp.user.last_name }}
                  </a>
                </option>
              {% endfor %}
            </select>
          </div>

        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="saveShiftBtn" class="btn btn-primary">Save Shift</button>
      </div>

    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {

  var calendarEl = document.getElementById('calendar');

  window.calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    events: '/api/shift_events/',
    dateClick: function(info) {
      document.getElementById("shiftDate").value = info.dateStr;
      var modal = new bootstrap.Modal(document.getElementById("createShiftModal"));
      modal.show();
    }
  });

  calendar.render();

  document.getElementById("createShiftBtn").addEventListener("click", function() {
      var modal = new bootstrap.Modal(document.getElementById("createShiftModal"));
      modal.show();
  });

});
</script>

<script>
document.getElementById("saveShiftBtn").addEventListener("click", function() {

  const payload = {
    date: document.getElementById("shiftDate").value,
    start_time: document.getElementById("shiftStart").value,
    end_time: document.getElementById("shiftEnd").value,
    role: document.getElementById("shiftRole").value,
    employee: document.getElementById("shiftEmployee").value || null
  };

  fetch("/api/create_shift/", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
    calendar.refetchEvents();
    bootstrap.Modal.getInstance(document.getElementById("createShiftModal")).hide();
  });
});
</script>
{% endblock %}